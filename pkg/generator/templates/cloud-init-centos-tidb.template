#cloud-config
write_files:
- path: '/etc/security/limits.d/99-tidb.conf'
  permissions: '0644'
  encoding: b64
  content: |
    cm9vdCAgICAgICAgc29mdCAgICAgICAgbm9maWxlICAgICAgICAxMDAwMDAwCnJvb3QgICAgICAgIGhhcmQgICAgICAgIG5vZmlsZSAgICAgICAgMTAwMDAwMApyb290ICAgICAgICBzb2Z0ICAgICAgICBjb3JlICAgICAgICAgIHVubGltaXRlZApyb290ICAgICAgICBzb2Z0ICAgICAgICBzdGFjayAgICAgICAgIDEwMjQw
- path: '/var/local-volume-provisioner/mount-nvme.sh'
  permissions: '0744'
  encoding: b64
  content: |
    IyEvYmluL3NoCgppZiBbICEgLWUgIi9kZXYvbnZtZTBuMSIgXSA7IHRoZW4KICBleGl0IDAKZmkKCiMgQXdzIHZvbHVtZSBwYXRoIC9kZXYvbnZtZTBuMSwgL2Rldi9udm1lMW4xCmRldnM9JChscyAtbGggL2Rldi9udm1lKm4xIHwgYXdrICd7cHJpbnQgJDEwfScpCmdjcERldnM9JChscyAtbGggL2Rldi9udm1lMG4qIHwgYXdrICd7cHJpbnQgJDEwfScpCgppZiBbICQoZWNobyAiJGRldnMiIHwgd2MgLWwpIC1sdCAkKGVjaG8gIiRnY3BEZXZzIiB8IHdjIC1sKSBdIDsgdGhlbgogIGRldnM9JGdjcERldnMKZmkKCiMgRG9uJ3QgY29tYmluZSBpZiB0aGVyZSBpcyAxIGRpc2suCmlmIFsgIiQoZWNobyAiJGRldnMiIHwgd2MgLWwpIiAtZXEgMSBdIDsgdGhlbgogIGlmIGxzIC9kZXYvbnZtZTBuMXAqID4gL2Rldi9udWxsIDI+JjE7IHRoZW4KICAgIGVjaG8gImRpc2sgL2Rldi9udm1lMG4xIGFscmVhZHkgcGFydGVkLCBza2lwcGluZyIKICBlbHNlCiAgICBlY2hvICJkaXNrIC9kZXYvbnZtZTBuMSBpcyBub3QgcGFydGVkIgogICAgaWYgISBibGtpZCAvZGV2L252bWUwbjEgPiAvZGV2L251bGw7IHRoZW4KICAgICAgZWNobyBub25lID4gL3N5cy9ibG9jay9udm1lMG4xL3F1ZXVlL3NjaGVkdWxlcgogICAgICBta2ZzIC10IGV4dDQgL2Rldi9udm1lMG4xCiAgICAgIERJU0tfVVVJRD0kKGJsa2lkIC1zIFVVSUQgLW8gdmFsdWUgL2Rldi9udm1lMG4xKQogICAgICBta2RpciAtcCAvbW50L2xvY2FsLXNzZC8kRElTS19VVUlECiAgICAgIGVjaG8gVVVJRD1gYmxraWQgLXMgVVVJRCAtbyB2YWx1ZSAvZGV2L252bWUwbjFgIC9tbnQvbG9jYWwtc3NkLyRESVNLX1VVSUQgZXh0NCBkZWZhdWx0cyAwIDIgfCB0ZWUgLWEgL2V0Yy9mc3RhYgogICAgZmkKICBmaQogIGV4aXQgMApmaQoKZm9yIHBhdGggaW4gJGRldnM7IGRvCiAgICBlY2hvICR7cGF0aCMiL2Rldi8ifQogICAgZWNobyBub25lID4gL3N5cy9ibG9jay8ke3BhdGgjIi9kZXYvIn0vcXVldWUvc2NoZWR1bGVyCmRvbmUKCnJhaWRfZGV2PS9kZXYvbWQwCmlmIFsgLWUgJHJhaWRfZGV2IF0gOyB0aGVuCiAgZXhpdCAwCmZpCgplY2hvIHkgfCAvc2Jpbi9tZGFkbSAtLWNyZWF0ZSAkcmFpZF9kZXYgLS1sZXZlbD0wIC0tcmFpZC1kZXZpY2VzPSQoZWNobyAiJGRldnMiIHwgd2MgLWwpICRkZXZzIC0tZm9yY2UKc3VkbyBta2ZzLmV4dDQgLUYgJHJhaWRfZGV2Cm5ld19kZXY9JHJhaWRfZGV2CmlmICEgdXVpZD0kKGJsa2lkIC1zIFVVSUQgLW8gdmFsdWUgJG5ld19kZXYpIDsgdGhlbgogIG1rZnMuZXh0NCAkbmV3X2RldgogIHV1aWQ9JChibGtpZCAtcyBVVUlEIC1vIHZhbHVlICRuZXdfZGV2KQpmaQoKbW50X2Rpcj0iL21udC9sb2NhbC1zc2QvJHV1aWQiCm1rZGlyIC1wICIkbW50X2RpciIKCmlmICEgZ3JlcCAiJHV1aWQiIC9ldGMvZnN0YWIgOyB0aGVuCiAgZWNobyAiVVVJRD0kdXVpZCAkbW50X2RpciBleHQ0ICRtbnRfb3B0cyIgPj4gL2V0Yy9mc3RhYgpmaQptb3VudCAtVSAiJHV1aWQiIC10IGV4dDQgLS10YXJnZXQgIiRtbnRfZGlyIiAtLW9wdGlvbnMgIiRtbnRfb3B0cyIKY2htb2QgYSt3ICIkbW50X2RpciI=
{{ if .Bootstrap -}}
- path: '/etc/cloud/cloud.cfg.d/custom-networking.cfg'
  permissions: '0644'
  encoding: b64
  content: |
    bmV0d29yazoKICBjb25maWc6IGRpc2FibGVkCg==
{{ end -}}
{{ if isContainerDEnabled .CRI -}}
- path: '/etc/systemd/system/containerd.service.d/11-exec_config.conf'
  permissions: '0644'
  encoding: b64
  content: |
    W1NlcnZpY2VdCkV4ZWNTdGFydD0KRXhlY1N0YXJ0PS91c3IvYmluL2NvbnRhaW5lcmQgLS1jb25maWc9L2V0Yy9jb250YWluZXJkL2NvbmZpZy50b21s
{{ end -}}
{{ range $_, $file := .Files -}}
- path: '{{ $file.Path }}'
{{- if $file.Permissions }}
  permissions: '{{ $file.Permissions }}'
{{- end }}
  encoding: b64
  content: |
    {{ $file.Content }}
{{ end -}}
{{- range $_, $unit := .Units -}}
{{ if $unit.Content -}}
- path: '{{ $unit.Path }}'
  encoding: b64
  content: |
    {{ $unit.Content }}
{{ end -}}
{{ if $unit.DropIns -}}
{{ range $_, $dropIn := $unit.DropIns.Items -}}
- path: '{{ $dropIn.Path }}'
  encoding: b64
  content: |
    {{ $dropIn.Content }}
{{- end -}}
{{- end -}}
{{- end }}

runcmd:
- until yum install -y yum-utils && yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo && yum install -y iptables docker-ce docker-ce-cli containerd.io socat nfs-utils logrotate jq wget; do sleep 1; done
- echo never > /sys/kernel/mm/transparent_hugepage/enabled
- echo never > /sys/kernel/mm/transparent_hugepage/defrag
- /bin/sh /var/local-volume-provisioner/mount-nvme.sh
- mount -a
- cp /lib/systemd/system/docker.service /etc/systemd/system/docker.service
- sed -i 's/LimitNOFILE=infinity/LimitNOFILE=1048576/' /etc/systemd/system/docker.service
- sed -i 's/LimitNPROC=infinity/LimitNPROC=1048576/' /etc/systemd/system/docker.service
- systemctl daemon-reload
{{ if .Bootstrap -}}
- systemctl restart docker
{{ end -}}
{{ range $_, $unit := .Units -}}
- systemctl enable '{{ $unit.Name }}' && systemctl restart '{{ $unit.Name }}'
{{ end -}}